name: Smarty Portal Framework CI/CD Pipeline

on:
  push:
    branches:
      - '**' # Trigger on all branches
  workflow_dispatch: # Manual trigger

jobs:
  deploy-to-development-server:
    name: Deploy to Development Server
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    env:
      WEBROOT: ${{ secrets.PORTAL_DEVELOPMENT_ROOT }}
      USER: admin
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Sync Framework Directory
        run: |
          if [ -z "$WEBROOT" ]; then echo "Need to set webroot as GitHub Actions secret" && exit 1; fi
          sudo rsync -rv ./framework/ $WEBROOT/framework --delete --exclude-from=./_exclusions.txt --exclude='composer.*'
          sudo rsync -rv ./ $WEBROOT --exclude 'framework' --exclude-from=./_exclusions.txt
          sudo chown $USER:$USER $WEBROOT -R

  production-ai-qr-labels-framework:
    name: Update AI QR Labels Production Portal Framework
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    env:
      WEBROOT: ${{ secrets.QR_LABELS_PRODUCTION_WEBROOT }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install UglifyJS
        run: |
          sudo npm install uglifyjs-folder -g
          uglifyjs-folder ./framework/js -eo ./framework/js/ -p "**/*.js"

      - name: Sync Framework Directory
        run: |
          if [ -z "$WEBROOT" ]; then echo "Need to set webroot as GitHub Actions secret" && exit 1; fi
          sudo rsync -rv ./framework/ $WEBROOT/framework --delete --exclude-from=./_exclusions.txt --exclude='composer.*'
          sudo rsync -rv ./ $WEBROOT --exclude 'framework' --exclude-from=./_exclusions.txt
          sudo chown 1004:users $WEBROOT -R